{"version":3,"sources":["../../src/lib/config/proxy.ts"],"names":["Joi","require","TargetFilterSchema","object","keys","path","array","items","string","regex","required","method","allow","TargetSchema","deny","FilterSchema","name","appliesTo","InterceptorSchema","InterceptorsSchema","request","response","exports","ProxyValidatorSchema","target","https","boolean","filter","interceptor","preserveHostHdr","timeout","number","validateProxyConfig","proxy","callback","validate"],"mappings":";;;;;;;;;AAEA,IAAYA,GAAA,GAAGC,OAAA,CAAM,KAAN,CAAf,C;;AA0KA,IAAIC,kBAAA,GAAqBF,GAAA,CAAIG,MAAJ,GAAaC,IAAb,CAAkB;AAAA,IACvCC,IAAA,EAAML,GAAA,CAAIM,KAAJ,GAAYC,KAAZ,CAAkBP,GAAA,CAAIQ,MAAJ,GAAaC,KAAb,CAAmB,eAAnB,CAAlB,EAAuDC,QAAvD,EADiC;AAAA,IAEvCC,MAAA,EAAQX,GAAA,CAAIM,KAAJ,GAAYC,KAAZ,CAAkBP,GAAA,CAAIQ,MAAJ,GAAaI,KAAb,CAAmB,KAAnB,EAA0B,MAA1B,EAAkC,KAAlC,EAAyC,QAAzC,EAAmD,OAAnD,EAA4D,SAA5D,EAAuE,MAAvE,CAAlB,EAAkGF,QAAlG,EAF+B;AAAA,CAAlB,CAAzB,C;;AAKA,IAAIG,YAAA,GAAeb,GAAA,CAAIG,MAAJ,GAAaC,IAAb,CAAkB;AAAA,IACjCC,IAAA,EAAML,GAAA,CAAIQ,MAAJ,GAAaE,QAAb,EAD2B;AAAA,IAEjCE,KAAA,EAAOV,kBAF0B;AAAA,IAGjCY,IAAA,EAAMZ,kBAH2B;AAAA,CAAlB,CAAnB,C;;AAMA,IAAIa,YAAA,GAAef,GAAA,CAAIG,MAAJ,GAAaC,IAAb,CAAkB;AAAA,IACjCY,IAAA,EAAMhB,GAAA,CAAIQ,MAAJ,GAAaE,QAAb,EAD2B;AAAA,IAEjCO,SAAA,EAAWjB,GAAA,CAAIM,KAAJ,GAAYC,KAAZ,CAAkBP,GAAA,CAAIQ,MAAJ,EAAlB,CAFsB;AAAA,CAAlB,CAAnB,C;;AAKA,IAAIU,iBAAA,GAAoBlB,GAAA,CAAIG,MAAJ,GAAaC,IAAb,CAAkB;AAAA,IACtCY,IAAA,EAAMhB,GAAA,CAAIQ,MAAJ,GAAaE,QAAb,EADgC;AAAA,IAEtCO,SAAA,EAAWjB,GAAA,CAAIM,KAAJ,GAAYC,KAAZ,CAAkBP,GAAA,CAAIQ,MAAJ,EAAlB,CAF2B;AAAA,CAAlB,CAAxB,C;;AAKA,IAAIW,kBAAA,GAAqBnB,GAAA,CAAIG,MAAJ,GAAaC,IAAb,CAAkB;AAAA,IACvCgB,OAAA,EAASpB,GAAA,CAAIM,KAAJ,GAAYC,KAAZ,CAAkBW,iBAAlB,EAAqCR,QAArC,EAD8B;AAAA,IAEvCW,QAAA,EAAUrB,GAAA,CAAIM,KAAJ,GAAYC,KAAZ,CAAkBW,iBAAlB,EAAqCR,QAArC,EAF6B;AAAA,CAAlB,CAAzB,C;;AAKWY,OAAA,CAAAC,oBAAA,GAAuBvB,GAAA,CAAIG,MAAJ,GAAaC,IAAb,CAAkB;AAAA,IAChDC,IAAA,EAAML,GAAA,CAAIQ,MAAJ,GAAaC,KAAb,CAAmB,eAAnB,EAAoCC,QAApC,EAD0C;AAAA,IAEhDc,MAAA,EAAQX,YAAA,CAAaH,QAAb,EAFwC;AAAA,IAGhDe,KAAA,EAAOzB,GAAA,CAAI0B,OAAJ,EAHyC;AAAA,IAIhDC,MAAA,EAAQ3B,GAAA,CAAIM,KAAJ,GAAYC,KAAZ,CAAkBQ,YAAlB,CAJwC;AAAA,IAKhDa,WAAA,EAAaT,kBALmC;AAAA,IAMhDU,eAAA,EAAiB7B,GAAA,CAAI0B,OAAJ,EAN+B;AAAA,IAOhDI,OAAA,EAAS9B,GAAA,CAAI+B,MAAJ,EAPuC;AAAA,CAAlB,CAAvB,C;AAUX,SAAAC,mBAAA,CAAoCC,KAApC,EAAkDC,QAAlD,EAA8E;AAAA,I,sCAAA;AAAA,I,sCAAA;AAAA,IAC1ElC,GAAA,CAAImC,QAAJ,CAAaF,KAAb,EAAoBX,OAAA,CAAAC,oBAApB,EAA0CW,QAA1C,EAD0E;AAAA,C;;AAA9DZ,OAAA,CAAAU,mBAAA,GAAmBA,mBAAnB","file":"proxy.js","sourcesContent":["\"use strict\";\n\nimport * as Joi from \"joi\";\n\n/**\n * Configuration for the API proxy engine.\n */\nexport interface Proxy {\n    /**\n     * The path where the gateway will listen for requests that should be proxied\n     * for the current API.\n     */\n    path: string;\n    /**\n     * The target address of the proxied API. You can force the protocol to be \n     * used on the URL, as:\n     * ```\n     * \"target\": {\n     *      \"path\": \"http://httpbin.org\",\n     *  }\n     * \n     * ```\n     * \n     * Or you can leave the decision for the gateway:\n     * \n     * \"target\": {\n     *      \"path\": \"httpbin.org\",\n     *  }\n     * \n     * So the gateway will use the same protocol used to access the gateway for the \n     * request to the target.\n     * \n     * If you want to force https for the target API request, use the https option.  \n     */\n    target: Target;\n    /**\n     * If set to true, will enforce the requests to the API target to use HTTPS protocol.\n     * f your path already define a protocol on target URL, this option is ignored.\n     */\n    https?: boolean\n    /**\n     * Add filters to the request pipeline. A Filter is a function that receives\n     * the request and the response object and must return a boolean value to inform\n     * it the given request should target the destination API or if it should be ignored.\n     * \n     * Example:\n     * ```\n     * module.exports = function (req, res) {\n     *   return true;\n     * };\n     * ```\n     * \n     * Each filter must be defined on its own .js file (placed on middleware/filter folder)\n     * and the fileName must match: <filterName>.js. \n     * \n     * So, the above filter should be saved in a file called myFilter.js and configured as:\n     * ```\n     * filter:[\n     *   {name: \"myFilter\"}\n     * ]\n     * ``` \n     */\n    filter?: Array<Filter>,\n    /**\n     * Add interceptors to the request pipeline. An Interceptor is a function that receives\n     * the request or the response object and can modify these objects.\n     * \n     * You can define two types of interceptors: Request Interceptors or Response Interceptors.\n     * \n     * Example of a request interceptor:\n     * ```\n     * module.exports = function(proxyReq, originalReq) {\n     *    // you can update headers \n     *    proxyReq.headers['Content-Type'] = 'text/html';\n     *    // you can change the method \n     *    proxyReq.method = 'GET';\n     *    // you can munge the bodyContent. \n     *    proxyReq.bodyContent = proxyReq.bodyContent.replace(/losing/, 'winning!');\n     *    return proxyReq;\n     * };\n     * ```\n     * \n     * Example of a response interceptor:\n     * ```\n     * module.exports = function(rsp, data, req, res, callback) {\n     *    // rsp - original response from the target \n     *    data = JSON.parse(data.toString('utf8'));\n     *    callback(null, JSON.stringify(data));\n     *    // callback follow the node conventions ```callback(error, value)```\n     * };\n     * ```\n     * \n     * Each interceptor must be defined on its own .js file (placed on middleware/interceptor/[request | response] folder)\n     * and the fileName must match: <interceptorName>.js. \n     * \n     * So, the above request interceptor should be saved in a file called \n     * middleware/interceptor/request/myRequestInterceptor.js and configured as:\n     * \n     * ```\n     * interceptor:{\n     *    request: [\"myRequestInterceptor\"]\n     * }\n     * ```\n     * \n     * If more than one request or response interceptor are defined, they are executed in declaration order. \n     */\n    interceptor?: Interceptors,\n    preserveHostHdr?: boolean;\n    timeout?: number;\n}\n\n/**\n * Add filters to the request pipeline. A Filter is a function that receives\n * the request and the response object and must return a boolean value to inform\n * it the given request should target the destination API or if it should be ignored.\n */\nexport interface Filter {\n    /**\n     * The filter name.\n     */\n    name: string,\n    /**\n     * A list of paths that should be filtered by this filter. If not provided, all paths\n     * will be filtered.\n     * Defaults to *.\n     */\n    appliesTo?: Array<string>;\n}\n\n/**\n * Add interceptors to the request pipeline. An Interceptor is a function that receives\n * the request or the response object and can modify these objects.\n */\nexport interface Interceptors {\n    /**\n     * A list of request interceptors\n     */\n    request: Array<Interceptor>;\n    /**\n     * A list of response interceptors\n     */\n    response: Array<Interceptor>;\n}\n\n/**\n * An Interceptor is a function that receives\n * the request or the response object and can modify these objects.\n */\nexport interface Interceptor {\n    /**\n     * The interceptor name.\n     */\n    name: string,\n    /**\n     * A list of paths that should be intercepted by this interceptor. If not provided, all paths\n     * will be intercepted.\n     * Defaults to *.\n     */\n    appliesTo?: Array<string>;\n}\n\nexport interface Target {\n    path: string;\n    allow?: TargetFilter;\n    deny?: TargetFilter;\n}\n\nexport interface TargetFilter {\n    path: Array<string>;\n    method: Array<string>;\n}\n\nlet TargetFilterSchema = Joi.object().keys({\n    path: Joi.array().items(Joi.string().regex(/^[a-z\\-\\/]+$/i)).required(),\n    method: Joi.array().items(Joi.string().allow('GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS', 'HEAD')).required(),\n});\n\nlet TargetSchema = Joi.object().keys({\n    path: Joi.string().required(),\n    allow: TargetFilterSchema,\n    deny: TargetFilterSchema,\n});\n\nlet FilterSchema = Joi.object().keys({\n    name: Joi.string().required(),\n    appliesTo: Joi.array().items(Joi.string())\n});\n\nlet InterceptorSchema = Joi.object().keys({\n    name: Joi.string().required(),\n    appliesTo: Joi.array().items(Joi.string())\n});\n\nlet InterceptorsSchema = Joi.object().keys({\n    request: Joi.array().items(InterceptorSchema).required(),\n    response: Joi.array().items(InterceptorSchema).required()\n});\n\nexport let ProxyValidatorSchema = Joi.object().keys({\n    path: Joi.string().regex(/^[a-z\\-\\/]+$/i).required(),\n    target: TargetSchema.required(),\n    https: Joi.boolean(),\n    filter: Joi.array().items(FilterSchema),\n    interceptor: InterceptorsSchema,\n    preserveHostHdr: Joi.boolean(),\n    timeout: Joi.number()\n});\n\nexport function validateProxyConfig(proxy: Proxy, callback: (err, value)=>void) {\n    Joi.validate(proxy, ProxyValidatorSchema, callback);\n}"]}