{"version":3,"sources":["proxy/proxy.js","../../src/lib/proxy/proxy.ts"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__metadata","k","v","metadata","typescript_ioc_1","require","settings_1","filter_1","interceptor_1","proxy","ApiProxy","prototype","api","settings","app","use","path","configureProxy","result","forwardPath","req","res","url","preserveHostHdr","timeout","https","filterChain","filter","buildFilters","forEach","f","requestInterceptor","interceptor","responseInterceptor","Inject","Settings","ProxyFilter","ProxyInterceptor","AutoWired","exports"],"mappings":"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","file":"proxy.js","sourcesContent":["\"use strict\";\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nvar typescript_ioc_1 = require(\"typescript-ioc\");\nvar settings_1 = require(\"../settings\");\nvar filter_1 = require(\"./filter\");\nvar interceptor_1 = require(\"./interceptor\");\nvar proxy = require(\"express-http-proxy\");\nvar ApiProxy = (function () {\n    function ApiProxy() {\n    }\n    ApiProxy.prototype.proxy = function (api) {\n        this.settings.app.use(api.proxy.path, proxy(api.proxy.target.path, this.configureProxy(api.proxy)));\n    };\n    ApiProxy.prototype.configureProxy = function (proxy) {\n        var result = {\n            forwardPath: function (req, res) {\n                return req.url;\n            }\n        };\n        if (proxy.preserveHostHdr) {\n            result['preserveHostHdr'] = proxy.preserveHostHdr;\n        }\n        if (proxy.timeout) {\n            result['timeout'] = proxy.timeout;\n        }\n        if (proxy.https) {\n            result['https'] = proxy.https;\n        }\n        var filterChain = this.filter.buildFilters(proxy);\n        if (filterChain && filterChain.length > 0) {\n            result['filter'] = function (req, res) {\n                var result = true;\n                filterChain.forEach(function (f) {\n                    if (result) {\n                        result = f(req, res);\n                    }\n                });\n                return result;\n            };\n        }\n        var requestInterceptor = this.interceptor.requestInterceptor(proxy);\n        if (requestInterceptor) {\n            result['decorateRequest'] = requestInterceptor;\n        }\n        var responseInterceptor = this.interceptor.responseInterceptor(proxy);\n        if (responseInterceptor) {\n            result['intercept'] = responseInterceptor;\n        }\n        return result;\n    };\n    __decorate([\n        typescript_ioc_1.Inject, \n        __metadata('design:type', settings_1.Settings)\n    ], ApiProxy.prototype, \"settings\", void 0);\n    __decorate([\n        typescript_ioc_1.Inject, \n        __metadata('design:type', filter_1.ProxyFilter)\n    ], ApiProxy.prototype, \"filter\", void 0);\n    __decorate([\n        typescript_ioc_1.Inject, \n        __metadata('design:type', interceptor_1.ProxyInterceptor)\n    ], ApiProxy.prototype, \"interceptor\", void 0);\n    ApiProxy = __decorate([\n        typescript_ioc_1.AutoWired, \n        __metadata('design:paramtypes', [])\n    ], ApiProxy);\n    return ApiProxy;\n}());\nexports.ApiProxy = ApiProxy;\n","\"use strict\";\n\nimport * as express from \"express\";\nimport * as StringUtils from \"underscore.string\";\nimport * as config from \"../config\";\nimport {AutoWired, Inject} from \"typescript-ioc\";\nimport {Settings} from \"../settings\";\nimport {ProxyFilter} from \"./filter\";\nimport {ProxyInterceptor} from \"./interceptor\";\n\nlet proxy = require(\"express-http-proxy\");\n\n/**\n * The API Proxy system. It uses [[express-http-proxy]](https://github.com/villadora/express-http-proxy)\n * to proxy requests to a target API.\n */\n@AutoWired\nexport class ApiProxy {\n    @Inject\n    private settings: Settings;\n\n    @Inject\n    private filter: ProxyFilter;\n\n    @Inject\n    private interceptor: ProxyInterceptor;\n\n    /**\n     * Configure a proxy for a given API\n     */\n    proxy(api: config.Api, ) {\n        this.settings.app.use(api.proxy.path, proxy(api.proxy.target.path, this.configureProxy(api.proxy)));\n    }\n    \n    private configureProxy(proxy: config.Proxy) {\n        let result = {\n            forwardPath: function(req: express.Request, res: express.Response) {\n                return req.url;\n            }\n        };\n        if (proxy.preserveHostHdr) {\n            result['preserveHostHdr']  = proxy.preserveHostHdr; \n        }\n        if (proxy.timeout) {\n            result['timeout']  = proxy.timeout; \n        }\n        if (proxy.https) {\n            result['https']  = proxy.https; \n        }\n        let filterChain: Array<Function> = this.filter.buildFilters(proxy);\n        if (filterChain && filterChain.length > 0) {            \n            result['filter'] = function(req, res) {\n                let result = true;\n                filterChain.forEach(f=>{\n                    if (result) {\n                        result = f(req, res);\n                    } \n                });\n                return result;\n            }; \n        }\n        let requestInterceptor: Function = this.interceptor.requestInterceptor(proxy);\n        if (requestInterceptor) {            \n            result['decorateRequest'] = requestInterceptor; \n        }\n        let responseInterceptor: Function = this.interceptor.responseInterceptor(proxy);\n        if (responseInterceptor) {            \n            result['intercept'] = responseInterceptor; \n        }\n        return result;\n    }\n}"]}