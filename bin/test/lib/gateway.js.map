{"version":3,"sources":["gateway.js","../../src/lib/gateway.ts"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__metadata","k","v","metadata","__param","paramIndex","decorator","fs","require","StringUtils","proxy_1","Utils","throttling_1","auth_1","es5_compat_1","settings_1","typescript_ioc_1","Gateway","settings","prototype","get","app","enumerable","configurable","initialize","ready","_this","apis","StringMap","path","apiPath","readdir","err","files","logger","error","endsWith","length_1","forEach","fileName","index","readJson","apiConfig","loadApi","api","info","name","proxy","apiKey","getApiKey","set","normalizePath","throttling","debug","apiRateLimit","authentication","apiAuth","apiProxy","version","Inject","ApiProxy","ApiRateLimit","ApiAuth","AutoWired","Singleton","Settings","exports"],"mappings":"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","file":"gateway.js","sourcesContent":["\"use strict\";\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\n    return function (target, key) { decorator(target, key, paramIndex); }\n};\nvar fs = require(\"fs-extra\");\nvar StringUtils = require(\"underscore.string\");\nvar proxy_1 = require(\"./proxy/proxy\");\nvar Utils = require(\"./proxy/utils\");\nvar throttling_1 = require(\"./throttling/throttling\");\nvar auth_1 = require(\"./authentication/auth\");\nvar es5_compat_1 = require(\"./es5-compat\");\nvar settings_1 = require(\"./settings\");\nvar typescript_ioc_1 = require(\"typescript-ioc\");\nvar Gateway = (function () {\n    function Gateway(settings) {\n        this.settings = settings;\n    }\n    Object.defineProperty(Gateway.prototype, \"server\", {\n        get: function () {\n            return this.settings.app;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Gateway.prototype.initialize = function (ready) {\n        var _this = this;\n        this.apis = new es5_compat_1.StringMap();\n        var path = this.settings.apiPath;\n        fs.readdir(path, function (err, files) {\n            if (err) {\n                _this.settings.logger.error(\"Error reading directory: \" + err);\n            }\n            else {\n                path = ((StringUtils.endsWith(path, '/')) ? path : path + '/');\n                var length_1 = files.length;\n                files.forEach(function (fileName, index) {\n                    if (StringUtils.endsWith(fileName, '.json')) {\n                        fs.readJson(path + fileName, function (error, apiConfig) {\n                            if (error) {\n                                _this.settings.logger.error(\"Error reading directory: \" + error);\n                            }\n                            else {\n                                _this.loadApi(apiConfig, (length_1 - 1 === index) ? ready : null);\n                            }\n                        });\n                    }\n                });\n            }\n        });\n    };\n    Gateway.prototype.loadApi = function (api, ready) {\n        this.settings.logger.info(\"Configuring API [\" + api.name + \"] on path: \" + api.proxy.path);\n        var apiKey = this.getApiKey(api);\n        this.apis.set(apiKey, api);\n        api.proxy.path = Utils.normalizePath(api.proxy.path);\n        if (api.throttling) {\n            this.settings.logger.debug(\"Configuring API Rate Limits\");\n            this.apiRateLimit.throttling(api.proxy.path, api.throttling);\n        }\n        if (api.authentication) {\n            this.settings.logger.debug(\"Configuring API Authentication\");\n            this.apiAuth.authentication(apiKey, api.proxy.path, api.authentication);\n        }\n        this.settings.logger.debug(\"Configuring API Proxy\");\n        this.apiProxy.proxy(api);\n        if (ready) {\n            ready();\n        }\n    };\n    Gateway.prototype.getApiKey = function (api) {\n        return api.name + (api.version ? '_' + api.version : '_default');\n    };\n    __decorate([\n        typescript_ioc_1.Inject, \n        __metadata('design:type', proxy_1.ApiProxy)\n    ], Gateway.prototype, \"apiProxy\", void 0);\n    __decorate([\n        typescript_ioc_1.Inject, \n        __metadata('design:type', throttling_1.ApiRateLimit)\n    ], Gateway.prototype, \"apiRateLimit\", void 0);\n    __decorate([\n        typescript_ioc_1.Inject, \n        __metadata('design:type', auth_1.ApiAuth)\n    ], Gateway.prototype, \"apiAuth\", void 0);\n    Gateway = __decorate([\n        typescript_ioc_1.AutoWired,\n        typescript_ioc_1.Singleton,\n        __param(0, typescript_ioc_1.Inject), \n        __metadata('design:paramtypes', [settings_1.Settings])\n    ], Gateway);\n    return Gateway;\n}());\nexports.Gateway = Gateway;\n","\"use strict\";\n\nimport * as express from \"express\";\nimport * as fs from \"fs-extra\";\nimport * as StringUtils from \"underscore.string\";\nimport * as config from \"./config\";\nimport {ApiProxy} from \"./proxy/proxy\";\nimport * as Utils from \"./proxy/utils\";\nimport {ApiRateLimit} from \"./throttling/throttling\";\nimport {ApiAuth} from \"./authentication/auth\";\nimport {Set, StringMap} from \"./es5-compat\";\nimport {Settings} from \"./settings\";\nimport {AutoWired, Inject, Singleton} from \"typescript-ioc\";\n\n@AutoWired\n@Singleton\nexport class Gateway {\n    @Inject\n    private apiProxy: ApiProxy;\n    @Inject\n    private apiRateLimit: ApiRateLimit;\n    @Inject\n    private apiAuth: ApiAuth;\n    private apis: StringMap<config.Api>;\n    private settings: Settings;\n\n    constructor(@Inject settings: Settings) {\n        this.settings = settings;\n    }    \n    \n    get server() : express.Application{\n        return this.settings.app;\n    }\n\n    initialize(ready?: () => void) {\n        this.apis = new StringMap<config.Api>();\n        let path = this.settings.apiPath;\n        fs.readdir(path, (err, files) => {\n            if (err) {\n                this.settings.logger.error(\"Error reading directory: \"+err);\n            }\n            else {\n                path = ((StringUtils.endsWith(path, '/'))?path:path+'/');\n                const length = files.length;\n                files.forEach((fileName, index) =>{\n                    if (StringUtils.endsWith(fileName, '.json')) {\n                        fs.readJson(path+fileName, (error, apiConfig: config.Api)=>{\n                            if (error) {\n                                this.settings.logger.error(\"Error reading directory: \"+error);\n                            }\n                            else {\n                                this.loadApi(apiConfig, (length -1 === index)?ready: null);\n                            }\n                        });\n                    }\n                });\n            }\n        });\n    }\n\n    loadApi(api: config.Api, ready?: () => void) {\n        this.settings.logger.info(\"Configuring API [\"+api.name+\"] on path: \"+api.proxy.path);\n        let apiKey: string = this.getApiKey(api);\n        this.apis.set(apiKey, api);\n        api.proxy.path = Utils.normalizePath(api.proxy.path);\n        \n        if (api.throttling) {\n            this.settings.logger.debug(\"Configuring API Rate Limits\");\n            this.apiRateLimit.throttling(api.proxy.path, api.throttling);\n        }\n        if (api.authentication) {\n            this.settings.logger.debug(\"Configuring API Authentication\");\n            this.apiAuth.authentication(apiKey, api.proxy.path, api.authentication);\n        }\n        this.settings.logger.debug(\"Configuring API Proxy\");\n        this.apiProxy.proxy(api);\n        \n        if (ready) {\n            ready();\n        }\n    }\n\n    private getApiKey(api: config.Api) {\n        return api.name + (api.version? '_'+api.version: '_default');\n    }\n}\n/*TODO: \n- Create a file for Gateway configurations:\n  - Global interceptors / Filters / Throttling\n- Create a global interceptor to add a 'Via' header pointing to Tree-Gateway\n- Expose an Admin port\n- Manage API versions\n- Fix the log (winston is not logging on log file, but just on consoles)\n- Create a clsuter program, to initialize the app in cluster\n*/"]}