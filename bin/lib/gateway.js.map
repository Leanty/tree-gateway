{"version":3,"sources":["../../src/lib/gateway.ts"],"names":[],"mappings":"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","file":"gateway.js","sourcesContent":["\"use strict\";\n\nimport * as express from \"express\";\nimport * as fs from \"fs-extra\";\nimport * as StringUtils from \"underscore.string\";\nimport * as config from \"./config\";\nimport {ApiProxy} from \"./proxy/proxy\";\nimport * as Utils from \"./proxy/utils\";\nimport {ApiRateLimit} from \"./throttling/throttling\";\nimport {ApiAuth} from \"./authentication/auth\";\nimport {Set, StringMap} from \"./es5-compat\";\nimport {Settings} from \"./settings\";\nimport {AutoWired, Inject, Singleton} from \"typescript-ioc\";\n\n@AutoWired\n@Singleton\nexport class Gateway {\n    @Inject\n    private apiProxy: ApiProxy;\n    @Inject\n    private apiRateLimit: ApiRateLimit;\n    @Inject\n    private apiAuth: ApiAuth;\n    private apis: StringMap<config.Api>;\n    private settings: Settings;\n\n    constructor(@Inject settings: Settings) {\n        this.settings = settings;\n    }    \n    \n    get server() : express.Application{\n        return this.settings.app;\n    }\n\n    initialize(ready?: () => void) {\n        this.apis = new StringMap<config.Api>();\n        let path = this.settings.apiPath;\n        fs.readdir(path, (err, files) => {\n            if (err) {\n                this.settings.logger.error(\"Error reading directory: \"+err);\n            }\n            else {\n                path = ((StringUtils.endsWith(path, '/'))?path:path+'/');\n                const length = files.length;\n                files.forEach((fileName, index) =>{\n                    if (StringUtils.endsWith(fileName, '.json')) {\n                        fs.readJson(path+fileName, (error, apiConfig: config.Api)=>{\n                            if (error) {\n                                this.settings.logger.error(\"Error reading directory: \"+error);\n                            }\n                            else {\n                                this.loadApi(apiConfig, (length -1 === index)?ready: null);\n                            }\n                        });\n                    }\n                });\n            }\n        });\n    }\n\n    loadApi(api: config.Api, ready?: () => void) {\n        this.settings.logger.info(\"Configuring API [\"+api.name+\"] on path: \"+api.proxy.path);\n        let apiKey: string = this.getApiKey(api);\n        this.apis.set(apiKey, api);\n        api.proxy.path = Utils.normalizePath(api.proxy.path);\n        \n        if (api.throttling) {\n            this.settings.logger.debug(\"Configuring API Rate Limits\");\n            this.apiRateLimit.throttling(api.proxy.path, api.throttling);\n        }\n        if (api.authentication) {\n            this.settings.logger.debug(\"Configuring API Authentication\");\n            this.apiAuth.authentication(apiKey, api.proxy.path, api.authentication);\n        }\n        this.settings.logger.debug(\"Configuring API Proxy\");\n        this.apiProxy.proxy(api);\n        \n        if (ready) {\n            ready();\n        }\n    }\n\n    private getApiKey(api: config.Api) {\n        return api.name + (api.version? '_'+api.version: '_default');\n    }\n}\n/*TODO: \n- Create a file for Gateway configurations:\n  - Global interceptors / Filters / Throttling\n- Create a global interceptor to add a 'Via' header pointing to Tree-Gateway\n- Expose an Admin port\n- Manage API versions\n- Fix the log (winston is not logging on log file, but just on consoles)\n- Create a clsuter program, to initialize the app in cluster\n*/"]}