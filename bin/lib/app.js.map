{"version":3,"sources":["../../src/lib/app.ts"],"names":[],"mappings":"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","file":"app.js","sourcesContent":["\"use strict\";\n\nimport * as express from \"express\";\nimport * as logger from \"morgan\";\nimport {Gateway} from \"./gateway\";\nimport * as fs from \"fs-extra\";\nimport * as compression from \"compression\";\nimport {Parameters} from \"./command-line\";\nimport {APIService} from \"./admin/admin-server\";\nimport * as path from \"path\";\nimport {Server} from \"typescript-rest\";\nimport {GatewayConfig} from \"./config/gateway\";\n\nlet defaults = require('defaults');\n\nfs.readJson(path.join(Parameters.rootDir,'tree-gateway.json'), (error, gatewayConfig: GatewayConfig)=>{\n    if (error) {\n        console.error(\"Error reading tree-gateway.json config file: \"+error);\n    }\n    else {\n      gatewayConfig =  defaults(gatewayConfig, {\n          rootPath : Parameters.rootDir,\n          apiPath : path.join(Parameters.rootDir +'/apis'),\n          middlewarePath : path.join(Parameters.rootDir +'/middleware')\n      });\n\n      let app = express();\n      let gateway: Gateway = new Gateway(app, gatewayConfig);\n      configureGatewayServer(gateway);\n      module.exports = app;\n\n      configureAdminServer();\n    }\n\n});\n\nfunction configureGatewayServer(gateway) {\n  gateway.server.disable('x-powered-by'); \n  gateway.server.use(compression());\n  //app.enable('trust proxy'); // If we are behind a reverse proxy (Heroku, Bluemix, AWS if you use an ELB, custom Nginx setup, etc) \n\n\n  if (gateway.server.get('env') == 'production') {\n    const accessLogStream = fs.createWriteStream(path.join(Parameters.rootDir, 'logs/access_errors.log'),{flags: 'a'});\n    gateway.server.use(logger('common', {\n      skip: function(req: express.Request, res: express.Response) { \n          return res.statusCode < 400 \n      }, \n      stream: accessLogStream }));\n  } \n  else {\n    gateway.server.use(logger('dev'));\n  }\n  gateway.initialize();\n  gateway.server.listen(Parameters.port, ()=>{\n    gateway.logger.info('Gateway listenning on port %d', Parameters.port);\n  });\n}\n\nfunction configureAdminServer() {\n  let adminServer = express();\n  adminServer.disable('x-powered-by'); \n  adminServer.use(compression());\n  adminServer.use(logger('dev'));\n\n  Server.buildServices(adminServer, APIService);\n  adminServer.listen(Parameters.adminPort, ()=>{\n    // winston.info('Gateway Admin API listenning on port %d', Parameters.adminPort);\n  });\n  return adminServer;\n}\n"]}